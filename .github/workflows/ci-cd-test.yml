name: Aegis Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better scanning
    
    - name: Install jq
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Pull Aegis image from Docker Hub
      run: |
        docker pull playerunknown23/aegis:latest
      
    - name: Run security scan
      env:
        AEGIS_API_KEY: ${{ secrets.AEGIS_API_KEY }}
        CONFIG_API_URL: ${{ secrets.CONFIG_API_URL }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF: ${{ github.ref }}
        GITHUB_SHA: ${{ github.sha }}
      run: |
        mkdir -p results
        docker run --rm \
          -v "$(pwd):/app/target:ro" \
          -v "$(pwd)/results:/app/results:rw" \
          -e AEGIS_API_KEY="$AEGIS_API_KEY" \
          -e CONFIG_API_URL="$CONFIG_API_URL" \
          -e GITHUB_REPOSITORY="$GITHUB_REPOSITORY" \
          -e GITHUB_REF="$GITHUB_REF" \
          -e GITHUB_SHA="$GITHUB_SHA" \
          playerunknown23/aegis:latest \
          /app/target \
          --api-key "$AEGIS_API_KEY" \
          ${CONFIG_API_URL:+--config-api-url "$CONFIG_API_URL"} \
          --parallel
        
        # Quality gate failure will exit with code 1, failing the build
      
    - name: Upload scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: results/
        retention-days: 30
      
    - name: Display scan summary
      if: always()
      run: |
        if [ -f results/scan_summary_*.json ]; then
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat results/scan_summary_*.json | jq -r '
            "**Summary:**\n" +
            "- Packages Found (SBOM): \(.summary.packages_found)\n" +
            "- Vulnerabilities in Packages (SCA): \(.summary.vulnerabilities_in_packages)\n" +
            "- Secrets Found: \(.summary.secrets_found)\n" +
            "- Code Vulnerabilities: \(.summary.code_vulnerabilities)\n" +
            "\n**Severity Breakdown:**\n" +
            "- Critical: \(.summary.critical_severity)\n" +
            "- High: \(.summary.high_severity)\n" +
            "- Medium: \(.summary.medium_severity)\n" +
            "- Low: \(.summary.low_severity)\n"
          ' >> $GITHUB_STEP_SUMMARY
          
          # Check for quality gate status in metadata if available
          QUALITY_GATE=$(cat results/scan_summary_*.json | jq -r '.metadata.quality_gate_passed // empty')
          if [ -n "$QUALITY_GATE" ]; then
            if [ "$QUALITY_GATE" = "true" ]; then
              echo "\nâœ… **Quality Gate: PASSED**" >> $GITHUB_STEP_SUMMARY
            else
              echo "\nâŒ **Quality Gate: FAILED**" >> $GITHUB_STEP_SUMMARY
              cat results/scan_summary_*.json | jq -r '.metadata.quality_gate_reasons[]? | "- \(.)"' >> $GITHUB_STEP_SUMMARY
            fi
          fi
        fi
